{% extends "ues/frame.html" %}
{% block title %} 小组信息 {% endblock %}
{% block contain %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1><b> {{ squads.name }} </b>
            <small>由 {{ squads.create_user }} 创建于 {{ squads.create_date }}</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>小组</a></li>
            <li class="active">小组信息</li>
        </ol>
    </section>
    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-md-8">
                <!-- Custom Tabs -->
                <div class="nav-tabs-custom">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#pro-count-table" data-toggle="tab">成员题数</a></li>
                        <li><a href="#pro-rating-table" id="problem-rating-tab" data-toggle="tab">成员Rating</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="pro-count-table">
                            <table id="problem-count-table"></table>
                        </div>
                        <!-- /.tab-pane -->
                        <div class="tab-pane" id="pro-rating-table">
                            <table id="problem-rating-table"></table>
                        </div>
                        <!-- /.tab-pane -->
                    </div>
                    <!-- /.tab-content -->
                    <div class="box-footer" id="user-info" hidden>
                        <label>最近动态</label>
                        <table class="table table-hover" id="last-message"></table>
                        <label>提交热点图</label>
                        <div style="height: 200px;" id="cal-heatmap"></div><br/>
                        <label>OJ所占比例及难度分布</label>
                        <div id="oj-proportion" style="height: 545px;"></div>
                    </div>
              </div>
              <!-- nav-tabs-custom -->
            </div>
            <div class="col-md-4">
                <!-- box -->
                <div class="box box-primary" id="squads-users">
                    <div class="box-header with-border">
                        <h3 class="box-title">小组成员</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <table id="squads_users_table" class="table table-hover">
                            <thead id="squads_users_thead">
                            </thead>
                            <tbody id="squads_users_tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- / .box -->
            </div>
        </div>
        <div class="row">
            <div class="col-md-9">
                <!-- box -->
                <div class="box" id="compare-div">
                    <div class="box-header with-border">
                        <h3 class="box-title">能力对比</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <label>题数增长曲线</label>
                        <div id="problem-count-line" style="height: 545px;"></div>
                        <label>每日题数增量曲线</label>
                        <div id="problem-every-day-count-line" style="height: 545px;"></div>
                        <label>每日题目难度曲线</label>
                        <div id="problem-every-day-rating-line" style="height: 545px;"></div>
                        <label>用户能力增长曲线</label>
                        <div id="users-rating-line" style="height: 545px;"></div>
                        <label>用户能力分布曲线</label>
                        <div id="users-ability-line" style="height: 545px;"></div>
                    </div>
                </div>
                <!-- / .box -->
            </div>
            <div class="col-md-3">
                <!-- box -->
                <div class="box box-primary" id="compare-users">
                    <div class="box-header with-border">
                        <h3 class="box-title">选择对比成员</h3>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <div id="selected-div" class="items">
                        </div>
                    </div>
                </div>
                <!-- / .box -->
            </div>
        </div>
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->
{% endblock %}
{% block page_js %}
<script type="text/javascript">
    let ECHARTS;
    let SQUADS_ID = {{ squads.id }};
    let CONFIG = {
        days: [1, 7, 15, 30, 90, 180, 365, 1000],
        rating: [0, 1000, 1500, 2000, 2500, 3000, 10000]
    }
    let REPO = [];

    // {
    //     'user1': {
    //         'name': 'aaa',
    //         'nickname': 'bbb',
    //     },
    //     ....
    // }
    let USERSINFO = {};

    // {
    //     'user1': {
    //         'Pku': {
    //             '1000': time,
    //             '1001': time,
    //             ...
    //         },
    //         'Hdu': {
    //             ...
    //         },
    //         ...
    //     }
    //     ...
    // }
    let USERACINFO = {};
    let USERACLIST = [];

    // {
    //     'user1': [
    //         [time1, total1],
    //         [time2, total2],
    //         [time3, total3],
    //         ...
    //     ],
    //     ...
    // }
    let USERACCOUNT = {};

    // {
    //     'Pku': {
    //         'user1': [
    //             {'date': xxx, 'rating': xxx},
    //             {'date': xxx, 'rating': xxx},
    //             ...
    //         ],
    //         ...
    //     },
    //     ...
    // }
    let USERRATING = {};

    // {
    //     'user1': {
    //         'time1': {
    //             'oj1': [],
    //             'oj2': [],
    //         },
    //         ...
    //     }
    //     ...
    // }
    let EVERYDAYINFO = {};

    // {
    //     'user1':[
    //         [time1, count, rating],
    //         [time2, count, rating],
    //         ...
    //     ],
    //     ...
    // }
    let EVERYDAYCOUNT = {};

    // {
    //     'user1':[
    //         [time1, rating, count],
    //         [time2, rating, count],
    //         ...
    //     ],
    //     ...
    // }
    let EVERYDAYAVGRATING = {};

    let PROBLEMRATING = {};

    // {
    //     'rmq': '数据结构',
    //     '线段树': '数据结构',
    //     '半平面交': '计算几何',
    //     ...
    // }
    let CLASSIFYDICT = {};

    // [
    //     'mainclass1': ['subclass1', 'subclass2'...],
    //     'mainclass2': ['subclass1', 'subclass2'...],
    //     ...
    // ]
    let CLASSIFY = [];
    // {
    //     'Pku': {
    //         '1000': ['rmq', '基本dp'],
    //         '1001': ['动态规划'],
    //         ...
    //     },
    //     'Hdu':{
    //         ...
    //     }
    //     ...
    // }
    let PROBLEMCLASSIFY = {};

    // {
    //     user1: {
    //         'overall': [xxx, xxx, ...],
    //         'mainclass1': [xxx, xxx],
    //         'mainclass2': [xxx, xxx],
    //         ...
    //     },
    //     ...
    // }
    let USERABILITY = {};

    Date.prototype.Format = function (fmt) { //author: meizz 
        var o = {
            "M+": this.getMonth() + 1, //月份 
            "d+": this.getDate(), //日 
            "h+": this.getHours(), //小时 
            "m+": this.getMinutes(), //分 
            "s+": this.getSeconds(), //秒 
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
            "S": this.getMilliseconds() //毫秒 
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

let initProblemCount = function(problemCount, ojOrder){
    $('#last-message').empty();
    let item = ['days'].concat(ojOrder).concat('Sum');
    let newRow = '<tr>';
    item.forEach(function(it){
        newRow += ('<th>' + it + '</th>');
    });
    newRow += '</tr>';
    $('#last-message').append(newRow);
    problemCount.forEach(function(data, index){
        newRow = '<tr>';
        item.forEach(function(it, dx){
            if(dx === 0){
                newRow += '<td>' + data['days'] +'天内</td>';
            }else{
                newRow += '<td>' + (data[it] || 0) + '</td>';
            }
        });
        newRow += '</tr>';
        $('#last-message').append(newRow);
    });
}

let initCalHeatMap = function(calHeatMap){
    let now = new Date();
    let year, month;
    let cur_year = now.getFullYear();
    let cur_month = now.getMonth() + 1;
    let last_day = (new Date(cur_year, cur_month, 0)).getDate();
    if(cur_month == 12){
        month = 1;
        year = cur_year;
    }else{
        year = cur_year - 1;
        month = cur_month + 1;
    }
    let time0 = year +'-'+ month +'-01';
    let time1 = cur_year +'-'+ cur_month +'-'+ last_day;

    let dom = document.getElementById("cal-heatmap");
    let myChart = ECHARTS.getInstanceByDom(dom);
    if(myChart === undefined){
        myChart = ECHARTS.init(dom);
    }

    let option = {
        tooltip: {
            position: 'top'
        },
        visualMap: {
            calculable: true,
            type: 'piecewise',
            orient: 'horizontal',
            left: 'center',
            top: 'top',
            pieces: [
                {max: 2},
                {min: 2, max: 3},
                {min: 3, max: 6},
                {min: 6, max: 10},
                {min: 10, max: 30},
                {min: 30},
            ]
        },
        calendar: [{
            left: 'center',
            range: [time0, time1],
            cellSize: ['auto', 16],
            yearLabel: {show: false},
            splitLine: {
                show: true,
                lineStyle: {
                    color: '#fff',
                    width: 10,
                    type: 'solid',
                }
            },
            itemStyle: {
                normal: {
                    color: "#ededed",
                    borderColor: "#fff"
                }
            }
        }],

        series: [{
            type: 'heatmap',
            coordinateSystem: 'calendar',
            calendarIndex: 0,
            data: calHeatMap
        }]

    };
    myChart.setOption(option, true);
    window.addEventListener('resize', function () {
        myChart.resize();
    });
}

let initOJProportion = function(problemAcList, problemRating, ojOrder, rating){
    data_right_out = {};
    series_data_in = [];
    series_data_out = [];
    legend_data_left = [];
    legend_data_right = [];
    ojOrder.forEach(function(oj, index){
        if(problemAcList[oj] == undefined){
            return true;
        }
        data_right_out[oj] = new Array(rating.length);
        legend_data_left.push(oj);
        series_data_in.push({'value': Object.keys(problemAcList[oj]).length, 'name': oj});
        for(let label in problemAcList[oj]){
            try{
                pro_rating = (problemRating[oj][label] || 1500);
            }catch(e){
                pro_rating = 1500;
            }
            cur_rating = 0;
            while(pro_rating > rating[cur_rating]){ cur_rating += 1;}
            data_right_out[oj][cur_rating] = (data_right_out[oj][cur_rating] || 0) + 1;
        }
    });
    ojOrder.forEach(function(oj, index){
        if(data_right_out[oj] == undefined){
            return true;
        }
        data_right_out[oj].forEach(function(cnt, dx){
            if(cnt){
                legend_name = oj + ' [' + rating[dx-1] + ', ' + rating[dx] + ')';
                series_data_out.push({'value': cnt, 'name': legend_name});
                legend_data_right.push(legend_name);
            }
        });
    });

    let dom = document.getElementById("oj-proportion");
    let myChart = ECHARTS.getInstanceByDom(dom);
    if(myChart === undefined){
        myChart = ECHARTS.init(dom);
    }

    let option = {
        tooltip : {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} ({d}%)"
        },
        legend: [
            {
                orient: 'vertical',
                left: 'left',
                data: legend_data_left,
            },
            {
                orient: 'vertical',
                right: 'right',
                data: legend_data_right,
            }
        ],
        series : [
            {
                type: 'pie',
                name: 'OJ题数占比',
                selectedMode: 'single',
                radius: [0, '36%'],
                label: {
                    normal: {
                        position: 'inner'
                    }
                },
                labelLine: {
                    normal: {
                        show: false
                    }
                },
                data: series_data_in,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            },
            {
                type:'pie',
                name:'OJ难度占比',
                radius: ['46%', '66%'],
                data: series_data_out
            }
        ]
    };
    myChart.setOption(option, true);
    window.addEventListener('resize', function () {
        myChart.resize();
    });
}

let initUserCompareCharts = function(){
    $("#problem-count-line").empty();
    let problem_count_dom = document.getElementById("problem-count-line");
    let problem_count_chart = ECHARTS.init(problem_count_dom);
    let problem_count_option = {
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        toolbox: {
            show : true,
            feature : {
                mark : {show: true},
                dataView : {show: true, readOnly: true},
                magicType: {show: true, type: ['line']},
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        calculable : true,
        legend: {},
        grid: {
            top: '12%',
            left: '1%',
            right: '1%',
            containLabel: true
        },
        xAxis: [
            {
                name: '时间',
                type : 'time',
                gridIndex: 0,
                boundaryGap: [0, '30%'],
            },
        ],
        yAxis: [
            {
                name : '题数',
                type : 'value',
                position: 'left',
                boundaryGap: [0, '30%'],
            },
        ],
        series : []
    };
    problem_count_chart.setOption(problem_count_option);
    window.addEventListener('resize', function () {
        problem_count_chart.resize();
    });

    $("#problem-every-day-count-line").empty();
    let problem_every_day_count_dom = document.getElementById("problem-every-day-count-line");
    let problem_every_day_count_chart = ECHARTS.init(problem_every_day_count_dom);
    let problem_every_day_count_option = {
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        toolbox: {
            show : true,
            feature : {
                mark : {show: true},
                dataView : {show: true, readOnly: true},
                magicType: {show: true, type: ['line']},
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        legend: {},
        grid: {
            top: '12%',
            left: '1%',
            right: '1%',
            containLabel: true
        },
        xAxis: [
            {
                name: '时间',
                type : 'time',
                boundaryGap: [0, '30%'],
            },
        ],
        yAxis: [
            {
                name : '题数',
                type : 'value',
                position: 'left',
                boundaryGap: [0, '30%'],
            },
        ],
        dataZoom: [{
            end: 100,
            start: 90,
            show: true,
            type: 'slider',
            filterModel: 'empty',
            labelFormatter: function (value) {
                return ECHARTS.format.formatTime('MM-dd', new Date(value));
            }
        }],
        series : []
    };
    problem_every_day_count_chart.setOption(problem_every_day_count_option);
    window.addEventListener('resize', function () {
        problem_every_day_count_chart.resize();
    });

    $("#problem-every-day-rating-line").empty();
    let problem_every_day_rating_dom = document.getElementById("problem-every-day-rating-line");
    let problem_every_day_rating_chart = ECHARTS.init(problem_every_day_rating_dom);
    let problem_every_day_rating_option = {
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        toolbox: {
            show : true,
            feature : {
                mark : {show: true},
                dataView : {show: true, readOnly: true},
                magicType: {show: true, type: ['line']},
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        legend: {},
        grid: {
            top: '12%',
            left: '1%',
            right: '1%',
            containLabel: true
        },
        xAxis: [
            {
                name: '时间',
                type : 'time',
                gridIndex: 0,
                boundaryGap: [0, '30%'],
            },
        ],
        yAxis: [
            {
                name : '题数',
                type : 'value',
                position: 'left',
                boundaryGap: [0, '30%'],
            },
        ],
        dataZoom: [{
            end: 100,
            start: 90,
            show: true,
            type: 'slider',
            filterModel: 'empty',
            labelFormatter: function (value) {
                return ECHARTS.format.formatTime('MM-dd', new Date(value));
            }
        }],
        series : []
    };
    problem_every_day_rating_chart.setOption(problem_every_day_rating_option);
    window.addEventListener('resize', function () {
        problem_every_day_rating_chart.resize();
    });

    ECHARTS.connect([problem_every_day_count_chart, problem_every_day_rating_chart]);


    $("#users-rating-line").empty();
    let users_rating_dom = document.getElementById("users-rating-line");
    let users_rating_chart = ECHARTS.init(users_rating_dom);
    let users_rating_option = {
        tooltip : {
            show: true,
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        toolbox: {
            show : true,
            feature : {
                mark : {show: true},
                dataView : {show: true, readOnly: true},
                magicType: {show: true, type: ['line']},
                restore : {show: true},
                saveAsImage : {show: true}
            }
        },
        calculable : true,
        legend: {},
        grid: {
            top: '12%',
            left: '1%',
            right: '1%',
            containLabel: true
        },
        xAxis: [
            {
                name: '时间',
                type : 'time',
                gridIndex: 0,
                boundaryGap: [0, '30%'],
            },
        ],
        yAxis: [
            {
                scale: true,
                name : 'rating',
                type : 'value',
                position: 'left',
                boundaryGap: [0, '30%'],
            },
        ],
        series : []
    };
    users_rating_chart.setOption(users_rating_option);
    window.addEventListener('resize', function () {
        users_rating_chart.resize();
    });

    $("#users-ability-line").empty();
    let indicator = [];
    CLASSIFY.forEach(function(data, index){
        indicator.push({'name': data['main_class']});
    });
    let users_ability_dom = document.getElementById("users-ability-line");
    let users_ability_chart = ECHARTS.init(users_ability_dom);
    let users_ability_option = {
        tooltip: {},
        legend: {},
        radar: {
            scale: true,
            indicator: indicator,
        },
        series: [{type: 'radar'}]
    };
    users_ability_chart.setOption(users_ability_option);
    window.addEventListener('resize', function () {
        users_ability_chart.resize();
    });
}

let showUserInfo = function(username, tableData){
    let oCountTable = $('#problem-count-table').DataTable();
    let oRatingTable = $('#problem-rating-table').DataTable();
    oCountTable.rows(function(idx, data, node){
        if(data['username'] == username){
            $(node).removeClass("hidden");
        }else{
            $(node).addClass("hidden");
        }
    });
    oRatingTable.rows(function(idx, data, node){
        if(data['username'] == username){
            $(node).removeClass("hidden");
        }else{
            $(node).addClass("hidden");
        }
    });

    let PROBLEMCOUNT = new Array(CONFIG.days.length);
    CONFIG.days.forEach(function(data, index){
        PROBLEMCOUNT[index] = {'days': data};
    });
    let now = new Date();
    for(let repo in (USERACINFO[username]|| {})){
        for(let label in (USERACINFO[username][repo]||{})){
            // PROBLEMCOUNT
            let cur_day = 0;
            let actime = new Date(USERACINFO[username][repo][label]);
            while(now - actime > CONFIG.days[cur_day] * 86400000){
                cur_day += 1;
            }
            while(cur_day < CONFIG.days.length){
                cur_day_data = (PROBLEMCOUNT[cur_day] || {});
                cur_day_data['Sum'] = (cur_day_data['Sum'] || 0) + 1;
                cur_day_data[repo] = (cur_day_data[repo] || 0) + 1;
                PROBLEMCOUNT[cur_day] = cur_day_data;
                cur_day += 1;
            }
        }
    }
    let calHeatMap = EVERYDAYCOUNT[username] || [];
    $('#user-info').removeAttr('hidden');
    initCalHeatMap(calHeatMap);
    initProblemCount(PROBLEMCOUNT, REPO);
    initOJProportion(USERACINFO[username], PROBLEMRATING, REPO, CONFIG.rating);
}

let initSquadsUsersInfo = function(problem_data, users_info){
    item = [
        {'title': '用户名', 'filed': 'username'},
        {'title': '姓名', 'filed': 'name'},
        {'title': '昵称', 'filed': 'nickname'},
    ];
    let newRow = '<tr>';
    item.forEach(function(it){
        newRow += ('<th>' + it['title'] + '</th>');
    });
    newRow += '</tr>';
    $('#squads_users_thead').append(newRow);
    problem_data.forEach(function(data, index){
        let username = data['username'];
        newRow = '<tr>';
        item.forEach(function(it, dx){
            if(dx === 0){
                newRow += '<td>' + username +'</td>';
            }else{
                newRow += '<td>' + (users_info[username][it['filed']]) + '</td>';
            }
        });
        newRow += '</tr>';
        $('#squads_users_table').append(newRow);
    });

    $('#squads_users_tbody tr').click(function(){
        let username = $(this).children('td:first').text();
        showUserInfo(username, problem_data);
    });
    $('#squads_users_tbody tr').hover(function(){
        $(this).css('cursor', 'pointer');
    });
}

let initProblemCountTable = function(columns, data){
    let aoColumnDefs = [{
        "orderable": false,
        "targets": 0
    },{
        "aTargets" :　["_all"],
        'class': 'center',
        "defaultContent": 0,
        "bSortable": true,
    }];
    $('#problem-count-table').DataTable({
        "data": data,
        "info": false,
        "paging": false,
        "autoWidth": true,
        "processing": true,
        "searching": false,
        "bAutoWidth": true,
        "columns": columns,
        "aoColumnDefs": aoColumnDefs,
        "order": [[ columns.length - 1, "desc" ]],
    });
}

let initUserAbilityTable = function(userAcInfo, userAbility, classify, userRating){
    let data = [];
    let columns = [{'title': '用户名', 'data': 'username'}];
    for(let user in userAcInfo){
        let sum = 0;
        let user_data = {};
        user_data['username'] = user;
        for(let i = 0; i < classify.length; i++){
            let cla = classify[i]['main_class'];
            user_data[cla] = parseInt(userAbility[user]['overall'][i]);
        }
        let rating = 0;
        let repo_cnt = 0;
        for(let repo in userRating){
            try{
                let len = userRating[repo][user].length;
                rating += userRating[repo][user][len - 1][1];
                repo_cnt += 1;
            }catch(e){}
        }
        if(repo_cnt == 0){rating=0, repo_cnt=1;}
        user_data['ELO'] = parseInt(rating / repo_cnt);
        data.push(user_data);
    }
    classify.forEach(function(cla, index){
        columns.push({'title': cla['main_class'], 'data': cla['main_class']});
    });
    columns.push({'title': 'ELO', 'data': 'ELO'});
    data.sort(function(a, b){
        return b['ELO'] - a['ELO'];
    });
    let aoColumnDefs = [{
        "orderable": false,
        "targets": 0
    },{
        "aTargets" :　["_all"],
        'class': 'center',
        "defaultContent": 0,
        "bSortable": true,
    }];
    $('#problem-rating-table').DataTable({
        "data": data,
        "info": false,
        "paging": false,
        "autoWidth": true,
        "processing": true,
        "searching": false,
        "bAutoWidth": true,
        "columns": columns,
        "aoColumnDefs": aoColumnDefs,
        "order": [[ columns.length - 1, "desc" ]],
    });
}

let initSelectedUserList = function(data){
    let row = "";
    data.forEach(function(data, index){
        row = "<input id='item" +index+ "' name='user_select' type='checkbox' value='"
                + data['username'] +"'>";
        $("#selected-div").append(row);
        row = "<label for='item" +index+ "'>" + data['username'] +' ('+ data['Sum']+')'+ "</label>";
        $("#selected-div").append(row);
    });
    row = "<p class='done' aria-hidden='true'>已选</p>";
    $("#selected-div").append(row);
    row = "<p class='undone' aria-hidden='true'>未选</p>";
    $("#selected-div").append(row);
    $("input[name='user_select']").click(function(){
        initUserCompare();
    });
}

let initUserCompareData = function(selectedUsers, UserAcCount, userRating, userAbility){
    let problem_count_series = [];
    selectedUsers.forEach(function(user, index){
        let series = {};
        series['name'] = user;
        series['type'] = 'line';
        series['smooth'] = true;
        series['data'] = UserAcCount[user];
        series['areaStyle'] = {'normal': {}};
        series['itemStyle'] = { 'normal': {'opacity': 0}};
        problem_count_series.push(series);
    });
    let problem_count_dom = document.getElementById("problem-count-line");
    let problem_count_chart = ECHARTS.getInstanceByDom(problem_count_dom);
    let problem_count_option = problem_count_chart.getOption();
    problem_count_option.legend = {data: selectedUsers};
    problem_count_option.series = problem_count_series;
    problem_count_chart.setOption(problem_count_option, true);

    let problem_every_day_count_legend = [];
    let problem_every_day_count_series = [];
    selectedUsers.forEach(function(user, index){
        let series = {};
        series['name'] = user;
        series['type'] = 'line';
        series['data'] = EVERYDAYCOUNT[user];
        problem_every_day_count_series.push(series);
        problem_every_day_count_legend.push({'name': user});
    });

    let problem_every_day_count_dom = document.getElementById("problem-every-day-count-line");
    let problem_every_day_count_chart = ECHARTS.getInstanceByDom(problem_every_day_count_dom);
    let problem_every_day_count_option = problem_every_day_count_chart.getOption();
    problem_every_day_count_option.legend = {data: problem_every_day_count_legend};
    problem_every_day_count_option.series = problem_every_day_count_series;
    problem_every_day_count_chart.setOption(problem_every_day_count_option, true);

    let problem_every_day_rating_legend = [];
    let problem_every_day_rating_series = [];
    selectedUsers.forEach(function(user, index){
        let series = {};
        series['name'] = user;
        series['type'] = 'line';
        series['data'] = EVERYDAYAVGRATING[user];
        problem_every_day_rating_series.push(series);
        problem_every_day_rating_legend.push({'name': user});
    });
    let problem_every_day_rating_dom = document.getElementById("problem-every-day-rating-line");
    let problem_every_day_rating_chart = ECHARTS.getInstanceByDom(problem_every_day_rating_dom);
    let problem_every_day_rating_option = problem_every_day_rating_chart.getOption();
    problem_every_day_rating_option.legend = {data: problem_every_day_rating_legend};
    problem_every_day_rating_option.series = problem_every_day_rating_series;
    problem_every_day_rating_chart.setOption(problem_every_day_rating_option, true);

    let users_rating_legend = [];
    let users_rating_series = [];
    for(let repo in userRating){
        users_rating_legend.push(repo);
        selectedUsers.forEach(function(user, index){
            let series = {};
            series['name'] = repo;
            series['type'] = 'line';
            series['smooth'] = true;
            series['data'] = userRating[repo][user];
            series['itemStyle'] = { 'normal': {'opacity': 0}};
            users_rating_series.push(series);
        });
    }
    let users_rating_dom = document.getElementById("users-rating-line");
    let users_rating_chart = ECHARTS.getInstanceByDom(users_rating_dom);
    let users_rating_option = users_rating_chart.getOption();
    users_rating_option.legend = {data: users_rating_legend};
    users_rating_option.series = users_rating_series;
    users_rating_chart.setOption(users_rating_option, true);

    let users_ability_series = [{
        data: [],
        type: 'radar',
        tooltip: {
            trigger: 'item'
        },
        itemStyle: {normal: {areaStyle: {type: 'default'}}},
    }];
    selectedUsers.forEach(function(user, index){
        let data = {};
        data['name'] = user;
        data['type'] = 'radar';
        data['value'] = userAbility[user]['overall'];
        data['label'] = {
            normal: {
                show: true,
                formatter: function(params){
                    return parseInt(params.value);
                }
            }
        };
        users_ability_series[0]['data'].push(data);
    });
    let users_ability_dom = document.getElementById("users-ability-line");
    let users_ability_chart = ECHARTS.getInstanceByDom(users_ability_dom);
    let users_ability_option = users_ability_chart.getOption();
    users_ability_option.legend = {data: selectedUsers};
    users_ability_option.series = users_ability_series;
    users_ability_chart.setOption(users_ability_option, true);
}

let initUserCompare = function(){
    let selected_users = [];
    let items = document.getElementsByName("user_select");
    items.forEach(function(data, index){
        if(!data.checked) return true;
        selected_users.push(data.value);
    });
    initUserCompareData(selected_users, USERACCOUNT, USERRATING, USERABILITY);
}

let getDataFromServer = function(url){
    return new Promise(function (resolve, reject){
        $.ajax({
            url: url,
            dataType: "json",
            type: "GET",
            cache: false,
            processData: false,
            contentType: false,
            success: function(response_data){
                resolve(response_data);
            },
            error: function(){
                reject(new Error('error'));
            }
        });
    });
}

require(['domready!', 'datatable', 'echarts'], function(doc, DataTable, echarts){

    ECHARTS = echarts;
    let initUsersAbilityData = function(){
        // {
        //     user1: {
        //         'total': {
        //             'mainclass1': {
        //                 'sum': xxx,
        //                 'count': xxx
        //             },
        //             ...
        //         },
        //         'mainclass1': {
        //             'subclass1': {
        //                 'sum': xxx,
        //                 'count': xxx
        //             },
        //             ...
        //         },
        //         ...
        //     },
        //     ...
        // }
        let overall_info = {};

        for(let user in USERACINFO){
            overall_info[user] = {};
            for(let repo in USERACINFO[user]){
                for(let label in USERACINFO[user][repo]){
                    let subClass, rating;
                    try{
                        rating = (PROBLEMRATING[repo][label] || 1500);
                    }catch(e){
                        rating = 1500;
                    }
                    try{
                        subClass = PROBLEMCLASSIFY[repo][label];
                        if(subClass[0] == undefined){
                            throw('空类型');
                        }
                    }catch(e){
                        subClass = ['其他'];
                    }
                    subClass.forEach(function(cla, index){
                        // 主类数据
                        let mainClass = CLASSIFYDICT[cla] || '其他';
                        let total = (overall_info[user]['total'] || {});
                        let overall_pcr = (total[mainClass] || {'sum': 0, 'count': 0});
                        overall_pcr['sum'] += rating;
                        overall_pcr['count'] += 1;
                        total[mainClass] = overall_pcr;
                        overall_info[user]['total'] = total;

                        let main_class = (overall_info[user][mainClass] || {});
                        let sub_class = (main_class[cla] || {'sum': 0, 'count': 0});
                        sub_class['sum'] += rating;
                        sub_class['count'] += 1;
                        main_class[cla] = sub_class;
                        overall_info[user][mainClass] = main_class;
                    });
                }
            }
        }
        for(let user in overall_info){
            let mainClass, subClass;
            USERABILITY[user] = {};
            USERABILITY[user]['overall'] = [];
            CLASSIFY.forEach(function(data, index){
                try{
                    mainClass = overall_info[user]['total'][data['main_class']];
                    if(mainClass === undefined){
                        throw('空类型');
                    }
                }catch(e){
                    mainClass = {'sum': 0, 'count': 1};
                }
                USERABILITY[user]['overall'].push(mainClass['sum'] / mainClass['count']);
                USERABILITY[user][data['main_class']] = [];
                data['sub_class'].forEach(function(cla, index){
                    try{
                        subClass = overall_info[user][data['main_class']][cla];
                        if(subClass === undefined){
                            throw('空类型');
                        }
                    }catch(e){
                        subClass = {'sum': 0, 'count': 1};
                    }
                    USERABILITY[user][data['main_class']].push(subClass['sum'] / subClass['count']);
                });
            });
        }
    }

    let initProblemCountData = function(userAcInfo){
        let data = [];
        let columns = [{'title': '用户名', 'data': 'username'}];
        for(let user in userAcInfo){
            let sum = 0;
            let user_data = {};
            user_data['username'] = user;
            for(let repo in userAcInfo[user]){
                let len = (Object.keys(userAcInfo[user][repo])).length;
                user_data[repo] = len;
                sum += len;
            }
            user_data['Sum'] = sum;
            data.push(user_data);
        }
        REPO.forEach(function(repo, index){
            columns.push({'title': repo, 'data': repo});
        });
        columns.push({'title': '总题数', 'data': 'Sum'});
        data.sort(function(a, b){
            return b['Sum'] - a['Sum'];
        });
        initSquadsUsersInfo(data, USERSINFO);
        initProblemCountTable(columns, data);
        initSelectedUserList(data);
    }

    let processUserACListDATA = function(response_data){
        USERACLIST = response_data;
        response_data.forEach(function(data, index){
            let user_info = USERACINFO[data['user__username']] || {};
            let repo_info = user_info[data['repo']] || {};
            repo_info[data['label']] = data['actime'];
            user_info[data['repo']] = repo_info;
            USERACINFO[data['user__username']] = user_info;
            if(REPO.indexOf(data['repo']) == -1){
                REPO.push(data['repo']);
            }

            // EVERYDAYINFO 
            let tmpTime = parseInt((new Date(data['actime'])).getTime() / 86400000) * 86400000;
            let userInfo = (EVERYDAYINFO[data['user__username']] || {});
            let dayInfo = (userInfo[tmpTime] || {});
            dayInfo[data['repo']] = (dayInfo[data['repo']] || []);
            dayInfo[data['repo']].push(data['label']);
            userInfo[tmpTime] = dayInfo;
            EVERYDAYINFO[data['user__username']] = userInfo;
        });
    }

    let processEveryDayInfo = function(){
        for(let user in EVERYDAYINFO){
            let time_list = Object.keys(EVERYDAYINFO[user]);
            time_list.sort(function(a, b){
                return a - b;
            });
            let userSum = 0;
            USERACCOUNT[user] = [];
            EVERYDAYCOUNT[user] = [];
            EVERYDAYAVGRATING[user] = [];
            time_list.forEach(function(time, index){
                let date = (new Date(parseInt(time))).Format("yyyy-MM-dd");
                let proCount = 0;
                let proRating = 0;
                for(let repo in EVERYDAYINFO[user][time]){
                    proCount += EVERYDAYINFO[user][time][repo].length;
                    EVERYDAYINFO[user][time][repo].forEach(function(label, index){
                        try{
                            proRating += (PROBLEMRATING[repo][label] || 1500);
                        }catch(e){
                            proRating += 1500;
                        }
                    });
                }
                userSum += proCount;
                USERACCOUNT[user].push([date, userSum]);
                EVERYDAYCOUNT[user].push([date, proCount]);
                EVERYDAYAVGRATING[user].push([date, proRating / proCount, user]);
            });
        }
    }

    let processUsersInfoData = function(response_data){
        response_data.forEach(function(data, index){
            USERSINFO[data['user']] = {
                'name': data['name'],
                'nickname': data['nickname']
            };
        });
    }

    let processProblemRatingData = function(response_data){
        PROBLEMRATING = response_data;
    }

    let processUserRatingData = function(response_data){
        for(let repo in response_data){
            USERRATING[repo] = {};
            for(let user in response_data[repo]){
                USERRATING[repo][user] = [];
                response_data[repo][user].forEach(function(data, index){
                    let len = USERRATING[repo][user].length;
                    let time = parseInt((new Date(data['date'])).getTime() / 86400000) * 86400000;
                    let rating = data['rating'];
                    if(len != 0 && USERRATING[repo][user][len - 1][0] == time){
                        USERRATING[repo][user][len - 1][1] = rating;
                    }else{
                        USERRATING[repo][user].push([time, rating, user]);
                    }
                });
            }
        }
    }

    let processProblemClassifyData = function(response_data){
        CLASSIFYDICT = response_data['all_classify'];
        PROBLEMCLASSIFY = response_data['problem_classify'];

        for(let subClass in CLASSIFYDICT){
            let flag = false;
            let mainClass = CLASSIFYDICT[subClass];
            for(let i = 0; i < CLASSIFY.length; i++){
                if(CLASSIFY[i]['main_class'] == mainClass){
                    CLASSIFY[i]['sub_class'].push(subClass);
                    flag = true;
                    break;
                }
            }
            if(!flag){
                CLASSIFY.push({'main_class': mainClass, 'sub_class': [subClass]});
            }
        }
    }

    let processUserRating = function(){
        return new Promise(function(resolve, reject){
            let url = "{% url 'squads_users_rating' squads_id=squads.id %}";
            getDataFromServer(url).then(function(response_data){
                processUserRatingData(response_data);
                resolve();
            });
        });
    }

    let processProblemClassify = function(){
        return new Promise(function(resolve, reject){
            let url = "{% url 'mate_problemclassify' %}";
            getDataFromServer(url).then(function(response_data){
                processProblemClassifyData(response_data);
                resolve();
            });
        });
    }

    let processUsersACList = function(){
        return new Promise(function(resolve, reject){
            let url = "{% url 'squads_users_aclist' squads_id=squads.id %}";
            getDataFromServer(url).then(function(response_data){
                processUserACListDATA(response_data);
                resolve();
            });
        });
    }

    let processUsersInfo = function(){
        return new Promise(function(resolve, reject){
            let url = "{% url 'squads_users_info' squads_id=squads.id %}";
            getDataFromServer(url).then(function(response_data){
                processUsersInfoData(response_data);
                resolve();
            });
        });
    }

    let processProblemRating = function(){
        return new Promise(function(resolve, reject){
            let url = "{% url 'mate_problemrating' %}";
            getDataFromServer(url).then(function(response_data){
                processProblemRatingData(response_data);
                resolve();
            });
        });
    }

    let processProblemMaterial = function(){
        return new Promise(function(resolve, reject){
            Promise.all([processProblemRating(), processProblemClassify()]).then(function(){
                processEveryDayInfo();
                initUsersAbilityData();
                resolve();
            });
        });
    }

    Promise.all([processUsersACList(), processUsersInfo()]).then(function(){
        initProblemCountData(USERACINFO);
        Promise.all([processProblemMaterial(), processUserRating()]).then(function(){
            initUserCompareCharts();
            initUserAbilityTable(USERACINFO, USERABILITY, CLASSIFY, USERRATING);
        });
    });
});

</script>
{% endblock %}
